{% extends 'base/base.html' %} 
{% block content %} 
{% include "base/title.html" with title=research_project.project.title subtitle=research_project.organization|add:"/"|add:research_project.supervisor button_text="ویرایش" button_link=research_project.get_absolute_url|add:"update/" %} 
{% for section in sections %}
<div class="row">
  <div
    class="page-header breadcrumb-header f-white outlined o-link c-main p-3 mr-2 ml-2 m-2">
    <div class="row align-items-end">
      <div class="col-lg-12">
        <div class="page-header-title">
          <div class="d-inline">
            <h3 class="lite-text">{{ section.title }}</h3>
            <span class="lite-text">
              <p>{{ section.content|safe }}</p>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}
<div class="row">
  <div
    class="page-header breadcrumb-header f-white outlined o-link c-main p-3 mr-2 ml-2 m-2">
    <div class="row align-items-end">
      <div class="col-lg-12">
        <div class="page-header-title">
          <div class="d-inline">
            <div class="row">
              <div class="col-10">
                <h3 class="lite-text">منابع</h3>
              </div>
              <div class="col-2 p-2">
                <div class="c-grey text-center m-auto col-12">
                  <button
                    type="button"
                    data-target="#NewReference"
                    data-toggle="modal"
                    class="btn outlined dashed c-second o-second btn-block fnt-xxs">
                    منبع جدید
                  </button>
                </div>
              </div>
            </div>

            <span class="lite-text">
              <table id="Article_list_Table" class="display">
                <thead>
                  <tr class="text-center">
                    <th class="">ردیف</th>
                    <th class="">
                      <input
                        type="text"
                        class="form-control filter-input-Article_list_Table"
                        data-column="1"
                        placeholder="کلید استناد" />
                    </th>
                    <th class="">
                      <input
                        type="text"
                        class="form-control filter-input-Article_list_Table"
                        data-column="2"
                        placeholder="عنوان" />
                    </th>
                    <th class="">
                      <input
                        type="text"
                        class="form-control filter-input-Article_list_Table"
                        data-column="3"
                        placeholder="نوع" />
                    </th>
                    <th class="">
                      <input
                        type="text"
                        class="form-control filter-input-Article_list_Table"
                        data-column="4"
                        placeholder="DOI" />
                    </th>
                    <th class="">ویرایش</th>
                  </tr>
                </thead>
                <tbody>

                  {% for reference in references %}
                  <tr class="text-center">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ reference.citation_key }}</td>
                    <td>
                      {% if reference.reference_type == 'article' %}
                        {{ reference.article.title }}
                      {% elif reference.reference_type == 'book' %}
                        {{ reference.book.project.title }}
                      {% elif reference.reference_type == 'thesis' %}
                        {{ reference.thesis.project.title }}
                      {% endif %}
                    </td>
                    <td>{{ reference.get_reference_type_display }}</td>
                    <td>{{ reference.doi }}</td>
                    <td>
                      <a
                        href="/ResearchProject/{{project.id}}"
                        type="button"
                        class="btn outlined c-second o-second btn-block fnt-xxs"
                        >ویرایش
                        <div class="ripple-container"></div
                      ></a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include "base/modal.html" with modal_id="NewReference" modal_label="exampleModalLabel" modal_title="منبع جدید" modal_body="<div class=\"form-group bmd-form-group\"> <label class=\"bmd-label-static\">DOI مقاله را وارد کنید</label> <input type=\"type\" class=\"form-control\" placeholder=\"DOI\" id=\"doiInput\" /> </div>" modal_action_button=True modal_action_text="ذخیره" modal_action_type="button" %}
{% endblock %} 
{% block scripts %}
<script>
  $(document).ready(function () {
    var table = $("#Article_list_Table").DataTable({
      paging: false,
      searching: true,
      ordering: false,
      info: false,
    });
    
    $(".filter-input-Article_list_Table").on("keyup change", function () {
      table.column($(this).data("column")).search(this.value).draw();
    });

    $('#NewReference').click(function() {
      const doi = $('#doiInput').val().trim();
      if (!doi) {
        showAlert('لطفاً DOI را وارد نمایید', { type: 'danger', duration: 3000 });
        return;
      }

      const projectId = {{ research_project.project.id }};
      $.ajax({
        url: `/references/add-with-doi/${projectId}/`,
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        data: {
          'doi': doi
        },
        beforeSend: function() {
          $('#doiResult').html('<div class="alert alert-info">در حال پردازش...</div>');
          $('#NewReference').prop('disabled', true);
        },
        success: function(response) {
          if (response.success) {
            showAlert('عملیات با موفقیت انجام شد', { type: 'success', duration: 3000 });
            setTimeout(function() { location.reload(); }, 3000);
          } else {
            showAlert(response.error || 'خطای نامشخص', { type: 'danger', duration: 3000 });
          }
        },
        error: function(xhr) {
          const error = xhr.responseJSON ? xhr.responseJSON.error : 'خطای سرور';
          showAlert(error, { type: 'danger', duration: 3000 });
        },
        complete: function() {
          $('#NewReference').prop('disabled', false);
        }
      });
    });
  });
</script>
{% endblock %}
